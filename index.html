<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.9.0/css/ol.css" type="text/css">
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.9.0/build/ol.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="index.css">
    </link>
    <title>OpenLayers Odev</title>
</head>

<body>
    <div>
        <div><img class="imgIcon"
                src="https://media-exp1.licdn.com/dms/image/C560BAQEnlb0HPWt_DA/company-logo_200_200/0/1522420792119?e=2159024400&v=beta&t=Hr56rqJZN_JApaLmrJ9QLFMqxrH4QN5dXliCJ5Eh42Y"
                alt="Belsis Yazılım"></div>
        <h2 class="header">Belsis Yazılım</h2>
    </div>
    <div id="map" class="map"></div> <!-- Ekrana harita bastırıldı -->
    <label for="type" class="parselTypeLabel">Geometry type:</label>
    <select class="parselBtn" id="type">
        <option class="parselOption" value="Polygon">Polygon</option>
        <option class="parselOption" value="Point">Point</option>
        <option class="parselOption" value="LineString">LineString</option>
    </select>
    <button class="parselBtn" id="editParsel">Edit</button>
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="formSave">
                <form>
                    <label for="fname">Şehir</label>
                    <input type="text" id="il">

                    <label for="lname">İlçe</label>
                    <input type="text" id="ilce">

                    <label for="lname">Mahalle</label>
                    <input type="text" id="mahalle">
                </form>
            </div>
            <button class="btnParselSave" id="saveParsel">Parseli Kaydet</button>
            <!-- onclick="saveParsel()" -->
        </div>
    </div>

    <!-- Trigger/Open The Modal -->
    <button id="myBtnEdit">Open Modal</button>
    <div id="myEditModal" class="modalUpdate">
        <div class="modalUpdate-content">
            <span class="closeUpdate">&times;</span>
            <div class="formSave">
                <form>
                    <label for="fname">Şehir</label>
                    <input type="text" id="ilEdit">

                    <label for="lname">İlçe</label>
                    <input type="text" id="ilceEdit">

                    <label for="lname">Mahalle</label>
                    <input type="text" id="mahalleEdit">
                </form>
            </div>
            <button class="btnParselSave" id="updateParsel">Parseli Güncelle</button>
            <button class="btnParselSave" id="deleteParsel">Parseli Sil</button>
        </div>
    </div>

</body>
<script type="text/javascript">
    var wkt = new ol.format.WKT()
    var feature, wktString;
    const raster = new ol.layer.Tile({
        source: new ol.source.OSM(),
    });

    const kaynak = new ol.source.Vector();

    const vector = new ol.layer.Vector({
        source: kaynak,
        style: new ol.style.Style({
            fill: new ol.style.Fill({
                color: 'rgba(255, 255, 255, 0.5)',
            }),
            stroke: new ol.style.Stroke({
                color: '#ffcc33',
                width: 2,
            }),
            image: new ol.style.Circle({
                radius: 7,
                fill: new ol.style.Fill({
                    color: '#ffcc33',
                }),
            }),
        }),
    });

    const modify = new ol.interaction.Modify({ source: kaynak });

    var map = new ol.Map({
        target: 'map',
        layers: [raster, vector],
        view: new ol.View({
            center: ol.proj.fromLonLat([37.41, 8.82]),
            zoom: 0
        })
    });

    map.addInteraction(modify);

    let draw, snap; // global so we can remove them later
    const typeSelect = document.getElementById('type');

    typeSelect.onchange = function () {
        map.removeInteraction(draw);
        map.removeInteraction(snap);
        addInteractions();
        map.un('click', callBack)

    };

    function addInteractions() {
        draw = new ol.interaction.Draw({
            source: kaynak,
            type: typeSelect.value,
        });
        map.addInteraction(draw);
        snap = new ol.interaction.Snap({ source: kaynak });
        map.addInteraction(snap);
        draw.on('drawend', drawend);
    }
    //----------------------------------------------------------------------------------------
    //Modal start

    var modal = document.getElementById("myModal");

    var span = document.getElementsByClassName("close")[0];

    // ModalSave açma
    function modalOpen() {
        modal.style.display = "block";
    }

    // İcona tıklayınca modal kapanır
    span.onclick = function () {
        document.getElementById('il').value = " "
        document.getElementById('ilce').value = " "
        document.getElementById('mahalle').value = " "

        var a = kaynak.getFeatures();
        var b = a[a.length - 1];
        kaynak.removeFeature(b);

        modal.style.display = "none";
    }

    //ModalSave finish
    //ModalEdit start
    var modall = document.getElementById("myEditModal");
    var btnn = document.getElementById("myBtnEdit");
    var spann = document.getElementsByClassName("closeUpdate")[0];
    btnn.onclick = function () {
        modall.style.display = "block";
    }
    spann.onclick = function () {
        modall.style.display = "none";
    }
    //ModalEdit finish
    //----------------------------------------------------------------------------------------
    addInteractions()

    function drawend(evt) {
        modalOpen()
        feature = evt.feature;
        //var x = feature.getGeometry().getCoordinates()
        wktString = wkt.writeFeature(feature);
    }
    function callBack(e) { //dbclick ??????
        map.forEachFeatureAtPixel(e.pixel, function (feature) {
            // document.getElementById('il').value = feature.A.parselIl
            // document.getElementById('ilce').value = feature.A.parselIlce
            // document.getElementById('mahalle').value = feature.A.pareselMahalle
            console.log(feature.A.wktString)
        })
    }
    $(document).ready(function () {
        $.ajax({ //list
            type: "get",
            url: "https://localhost:44393/api/Parsel/all",
            success: parselList
        });
        $("#saveParsel").click(function () { //add
            modal.style.display = "none";
            var il = document.getElementById('il').value
            var ilce = document.getElementById('ilce').value
            var mahalle = document.getElementById('mahalle').value
            var wktS = wktString
            let parselJson = { parselIl: il, parselIlce: ilce, pareselMahalle: mahalle, wktString: wktS }
            $.ajax({
                type: "post",
                url: "https://localhost:44393/api/Parsel/add",
                //data: parselJson,
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(parselJson),
                success: successSave,
                dataType: "json",
            });
        });
        $("#editParsel").click(function () { //edit
            map.removeInteraction(draw)
            map.removeInteraction(snap)
            // map.removeInteraction(event)
            map.on('click', callBack)
        });
        $("#updateParsel").click(function (){
            console.log("guncelleme...")
        })
        $("#deleteParsel").click(function (){
            console.log("silme...")
        })
    });

    function successSave(res) {
        document.getElementById('il').value = " "
        document.getElementById('ilce').value = " "
        document.getElementById('mahalle').value = " "
        console.log("Kayıt başarılı")
    }

    function parselList(res) {
        res.forEach(element => {
            const parsel = wkt.readFeature(element.wktString, {
                dataProjection: 'EPSG:3857',
                featureProjection: 'EPSG:3857',
            });
            parsel.set('parselId', element.parselId)
            parsel.set('parselIl', element.parselIl)
            parsel.set('parselIlce', element.parselIlce)
            parsel.set('pareselMahalle', element.pareselMahalle)
            parsel.set('wktString', element.wktString)
            kaynak.addFeature(parsel)
        });
    }

    // Herhangi bir yere tıklayınca modal kapanır
    window.onclick = function (event) {
        if (event.target == modal) {
            document.getElementById('il').value = " "
            document.getElementById('ilce').value = " "
            document.getElementById('mahalle').value = " "

            var a = kaynak.getFeatures();
            var b = a[a.length - 1];
            kaynak.removeFeature(b);

            modal.style.display = "none";
        }
        else if (event.target == modall) {
            modall.style.display = "none";
        }
    }

</script>

</html>